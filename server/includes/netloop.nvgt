void netloop() {
	try {
	if (shutdown && sdtimer.elapsed > shutdowntime * 1000) {
		sdtimer.restart();
		shutdown = false;
		svshutdown(shutdownreason);
	}
	if (reboot && rbtimer.elapsed > reboottime * 1000) {
		rbtimer.restart();
		reboot = false;
		svreboot(rebootreason);
	}
	if (exiting && extimer.elapsed > extime) {
		extimer.restart();
		exiting = false;
		exitsvr(exrestart);
	}
	if (maps.length() > 0) {
		for (uint i = 0; i < maps.length(); i++)
			if (@maps[i] != null)
				maps[i].loop();
	}
	if (players.length() > 0) {
		for (uint i = 0; i < players.length(); i++)
			if (@players[i] != null)
				players[i].loop(i);
	}
	if (onlineplength != players.length() && !weblock) {
		onlineplength = players.length();
		on_web({"player"});
	}
	ntmsloop();
	weaponloop();
	if (ais.length() > 0) {
		for (int i = ais.length() - 1; i >= 0; i--) {
			if (@ais[i] != null) {
				ais[i].loop(i);
			}
		}
	}
	if (houses.length() > 0) {
		for (uint i = 0; i < houses.length(); i++)
			if (@houses[i] != null)
				houses[i].loop(i);
	}
	if (apartments.length() > 0) {
		for (uint i = 0; i < apartments.length(); i++)
			if (@apartments[i] != null)
				apartments[i].loop(i);
	}
	if (tents.length() > 0) {
		for (uint i = 0; i < tents.length(); i++)
			if (@tents[i] != null)
				tents[i].loop(i);
	}
	if (playerstores.length() > 0) {
		for (uint i = 0; i < playerstores.length(); i++)
			if (@playerstores[i] != null)
				playerstores[i].loop(i);
	}
	if (robots.length() > 0) {
		for (uint i = 0; i < robots.length(); i++)
			if (@robots[i] != null)
				robots[i].loop(i);
	}
	if (washbasins.length() > 0) {
		for (uint i = 0; i < washbasins.length(); i++)
			if (@washbasins[i] != null)
				washbasins[i].loop(i);
	}
	if (showers.length() > 0) {
		for (uint i = 0; i < showers.length(); i++)
			if (@showers[i] != null)
				showers[i].loop(i);
	}
	if (item_cariers.length() > 0) {
		for (uint i = 0; i < item_cariers.length(); i++)
			if (@item_cariers[i] != null)
				item_cariers[i].loop(i);
	}
	if (firemaps.length() > 0) {
		for (uint i = 0; i < firemaps.length(); i++)
			if (@firemaps[i] != null)
				firemaps[i].loop(i);
	}
	if (timeitems.length() > 0) {
		for (uint i = 0; i < timeitems.length(); i++)
			if (@timeitems[i] != null)
				timeitems[i].loop(i);
	}
	if (timepackets.length() > 0) {
		for (uint i = 0; i < timepackets.length(); i++)
			if (@timepackets[i] != null)
				timepackets[i].loop(i);
	}
	if (time_bombs.length() > 0) {
		for (uint i = 0; i < time_bombs.length(); i++)
			if (@time_bombs[i] != null)
				time_bombs[i].loop(i);
	}
	if (mines.length() > 0) {
		for (uint i = 0; i < mines.length(); i++)
			if (@mines[i] != null)
				mines[i].loop(i);
	}
	if (vending_machines.length() > 0) {
		for (uint i = 0; i < vending_machines.length(); i++)
			if (@vending_machines[i] != null)
				vending_machines[i].loop();
	}
	if (bodyfalls.length() > 0) {
		for (uint i = 0; i < bodyfalls.length(); i++)
			if (@bodyfalls[i] != null)
				bodyfalls[i].loop(i);
	}
	if (censor_bombs.length() > 0) {
		for (uint i = 0; i < censor_bombs.length(); i++)
			if (@censor_bombs[i] != null)
				censor_bombs[i].loop(i);
	}
	if (snares.length() > 0) {
		for (uint i = 0; i < snares.length(); i++)
			if (@snares[i] != null)
				snares[i].loop(i);
	}
	if (canisters.length() > 0) {
		for (uint i = 0; i < canisters.length(); i++)
			if (@canisters[i] != null)
				canisters[i].loop(i);
	}
	if (rpgs.length() > 0) {
		for (uint i = 0; i < rpgs.length(); i++)
			if (@rpgs[i] != null)
				rpgs[i].loop(i);
	}
	if (rockets.length() > 0) {
		for (uint i = 0; i < rockets.length(); i++)
			if (@rockets[i] != null)
				rockets[i].loop(i);
	}
	if (auto_healers.length() > 0) {
		for (uint i = 0; i < auto_healers.length(); i++)
			if (@auto_healers[i] != null)
				auto_healers[i].loop(i);
	}
	if (microwaves.length() > 0) {
		for (uint i = 0; i < microwaves.length(); i++)
			if (@microwaves[i] != null)
				microwaves[i].loop(i);
	}
	if (teams.length() > 0) {
		for (uint i = 0; i < teams.length(); i++)
			if (@teams[i] != null)
				teams[i].loop(i);
	}
	if (lockers.length() > 0) {
		for (uint i = 0; i < lockers.length(); i++)
			if (@lockers[i] != null)
				lockers[i].loop(i);
	}
	if (fridges.length() > 0) {
		for (uint i = 0; i < fridges.length(); i++)
			if (@fridges[i] != null)
				fridges[i].loop(i);
	}
	if (fires.length() > 0) {
		for (uint i = 0; i < fires.length(); i++)
			if (@fires[i] != null)
				fires[i].loop(i);
	}
	if (fire_starters.length() > 0) {
		for (uint i = 0; i < fire_starters.length(); i++)
			if (@fire_starters[i] != null)
				fire_starters[i].loop(i);
	}
	if (grenades.length() > 0) {
		for (uint i = 0; i < grenades.length(); i++)
			if (@grenades[i] != null)
				grenades[i].loop(i);
	}
	if (xp_check_timer.elapsed >= 60000) {
		xp_check_timer.restart();
		check_auto_xp();
	}
	if (savetimer.elapsed >= 50000 and writeprefs == 1) {
		savetimer.restart();
		svd::save();
		garbage_collect();
	}
	if (TIME_HOUR > 6 and TIME_HOUR<19 and nightendo == 1 and timetimer.elapsed>60000) {
		timetimer.restart();
		send_reliable(0, "fimnight", 0);
		send_reliable(0, "volumenight -12", 0);
		nightendo = 0;
	}
	if (TIME_HOUR >= 19 and TIME_HOUR <= 24 and nightendo == 0 and timetimer.elapsed > 60000) {
		timetimer.restart();
		send_reliable(0, "volumenight -7", 0);
		volumenight = -12;
		numeronight = random(3, 4);
		send_reliable(0, "nightativa " + numeronight, 0);
		nightendo = 1;
		volumenight1 = 0;
		volumenight2 = 0;
		volumenight3 = 0;
		volumenight4 = 0;
		volumenight5 = 0;
		volumenight6 = 0;
		volumenight7 = 0;
		volumenight8 = 0;
		volumenight9 = 0;
		volumenight10 = 0;
	}
	if (TIME_HOUR >= 1 and TIME_HOUR <= 6 and nightendo == 0 and timetimer.elapsed > 60000) {
		timetimer.restart();
		send_reliable(0, "volumenight -7", 0);
		volumenight = -12;
		numeronight = random(3, 4);
		send_reliable(0, "nightativa " + numeronight, 0);
		nightendo = 1;
		volumenight1 = 0;
		volumenight2 = 0;
		volumenight3 = 0;
		volumenight4 = 0;
		volumenight5 = 0;
		volumenight6 = 0;
		volumenight7 = 0;
		volumenight8 = 0;
		volumenight9 = 0;
		volumenight10 = 0;
	}
	if (TIME_HOUR == 5 and TIME_MINUTE == 59 and timetimer.elapsed > 60000) {
		timetimer.restart();
		send_reliable(0, "play_s notify_magicbell.ogg", 6);
		send_reliable(0, "The sun is rising from the back of the mountain, since it is 6 o'clock in the morning", 2);
		if (nightendo == 1) {
			send_reliable(0, "fimnight", 0);
			send_reliable(0, "volumenight -12", 0);
			nightendo = 0;
		}
	}
	if (TIME_HOUR == 11 and TIME_MINUTE == 59 and timetimer.elapsed > 60000) {
		timetimer.restart();
		send_reliable(0, "play_s notify_trumpet.ogg", 6);
		send_reliable(0, "The sun has reached the middle of the sky, indicating that it is noon!", 2);
	}
	if (TIME_HOUR == 18 and TIME_MINUTE == 59 and timetimer.elapsed > 60000) {
		timetimer.restart();
		send_reliable(0, "play_s notify_woosh.ogg", 6);
		send_reliable(0, "The sun is drowning. Yes! time is 7 pm!", 2);
		if (nightendo == 0) {
			send_reliable(0, "volumenight -7", 0);
			volumenight = -12;
			numeronight = random(3, 4);
			send_reliable(0, "nightativa " + numeronight, 0);
			nightendo = 1;
			volumenight1 = 0;
			volumenight2 = 0;
			volumenight3 = 0;
			volumenight4 = 0;
			volumenight5 = 0;
			volumenight6 = 0;
			volumenight7 = 0;
			volumenight8 = 0;
			volumenight9 = 0;
			volumenight10 = 0;
		}
	}
	if (TIME_HOUR == 23 and TIME_MINUTE == 59 and timetimer.elapsed > 60000) {
		timetimer.restart();
		send_reliable(0, "play_s notify" + random(1, 10) + ".ogg", 6);
		send_reliable(0, "since it is midnight, a new day begins", 2);
		string[] chars = find_directories("chars/*");
		for (uint i = 0; i < chars.length(); i++) {
			file f;
			f.open("chars/" + chars[i] + "/giftlimit.usr", "wb");
			f.write(0);
			f.close();
		}
	}
	if (players.length() > peak) {
		peak = players.length();
		send_reliable(0, "peak we have reached a new peak of " + peak + " players!", 0);
		peakreached = get_date() + " at " + get_time();
		string[] t;
		t.insert_last(random(13, 19) + " 5.56mm_ammo");
		t.insert_last(random(10, 15) + " 7.62mm_ammo");
		t.insert_last(random(8, 14) + " 9mm_ammo");
		t.insert_last(random(5, 7) + " 12.7mm_ammo");
		t.insert_last(random(8, 13) + " shotgun_shell");
		//t.insert_last(random(3, 10)+" arrow");
		t.insert_last(random(25, 100) + " coins");
		t.insert_last(random(1, 5) + " paid_gift");
		t.insert_last(random(1, 5) + " staff_gift");
		//t.insert_last(random(1, 25)+" mana");
		int nitem = random(0, t.length() - 1);
		string[] a = string_split(t[nitem], " ", false);
		int numero = string_to_number(a[0]);
		string nome = a[1];
		send_reliable(0, "play_s notify_applause.ogg", 6);
		for (uint n = 0; n < players.length(); n++) {
			send_packet(6, "play get" + get_draw_and_get_sound(nome) + ".ogg " + players[n].x + " " + players[n].y + " " + players[n].z, players[n].x, players[n].y, players[n].z, maps[get_map_index(players[n].map)]);
			players[n].inv_add_item(nome, numero);
			send_reliable(players[n], "as a peak gift, you've got " + numero + " " + nome, 2);
		}
	}
	auction::loop();
	if (chovendo == 1 && fire_starters.length() > 0) {
		for (uint i = 0; i < fire_starters.length(); i++) {
			@fire_starters[i] = null;
			fire_starters.remove_at(i);
			continue;
		}
	}
	if (chuvatimer.elapsed > chuvatempo and chovendo == 0) {
		chuvatimer.restart();
		send_reliable(0, "volumechuva -7", 0);
		volumechuva = -12;
		numerochuva = random(3, 4);
		send_reliable(0, "chuvaativa " + numerochuva, 0);
		chovendo = 1;
		trov1 = 0;
		trov2 = 0;
		trov3 = 0;
		trov4 = 0;
		trov5 = 0;
		trov6 = 0;
		trov7 = 0;
		trov8 = 0;
		trov9 = 0;
		trov10 = 0;
		volumechuva1 = 0;
		volumechuva2 = 0;
		volumechuva3 = 0;
		volumechuva4 = 0;
		volumechuva5 = 0;
		volumechuva6 = 0;
		volumechuva7 = 0;
		volumechuva8 = 0;
		volumechuva9 = 0;
		volumechuva10 = 0;
	}
	if (chuvatimer.elapsed > 500000 and chovendo == 1) {
		chuvatimer.restart();
		send_reliable(0, "fimchuva", 0);
		send_reliable(0, "volumechuva -12", 0);
		chovendo = 0;
	}
	if (chuvatimer.elapsed >= 498000 and chovendo == 0 and trov1 == 0) {
		jraio();
		trov1 = 1;
	}
	if (chuvatimer.elapsed >= 1500 and chovendo == 1 and trov2 == 0) {
		jraio();
		send_reliable(0, "volumechuva -12", 0);
		volumechuva = -12;
		trov2 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 20000 and chovendo == 1 and trov9 == 0) {
		jraio();
		volumechuva = -10;
		send_reliable(0, "volumechuva -10", 0);
		trov9 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 43000 and chovendo == 1 and trov10 == 0) {
		jraio();
		volumechuva = -8;
		send_reliable(0, "volumechuva -8", 0);
		trov10 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 45000 and chovendo == 1 and volumechuva1 == 0) {
		jraio();
		volumechuva = -6;
		volumechuva1 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 47000 and chovendo == 1 and volumechuva2 == 0) {
		send_reliable(0, "volumechuva -4", 0);
		volumechuva = -4;
		volumechuva2 = 1;
		int jogaronda = random(1, 200);
		if (jogaronda < 10)
			send_reliable(0, "play_s thunder" + random(1, 50) + ".ogg", 6);
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 48000 and chovendo == 1 and volumechuva3 == 0) {
		send_reliable(0, "volumechuva -2", 0);
		volumechuva = -2;
		volumechuva3 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 50000 and chovendo == 1 and volumechuva4 == 0) {
		send_reliable(0, "volumechuva 1000", 0);
		volumechuva = 1000;
		volumechuva4 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 60000 and chovendo == 1 and trov3 == 0) {
		jraio();
		trov3 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 150000 and chovendo == 1 and trov4 == 0) {
		jraio();
		trov4 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 180000 and chovendo == 1 and trov5 == 0) {
		jraio();
		trov5 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 240000 and chovendo == 1 and trov6 == 0) {
		jraio();
		trov6 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 300000 and chovendo == 1 and trov7 == 0) {
		jraio();
		trov7 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 451000 and chovendo == 1 and volumechuva9 == 0) {
		volumechuva = -2;
		send_reliable(0, "volumechuva -2", 0);
		volumechuva9 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 452000 and chovendo == 1 and volumechuva8 == 0) {
		send_reliable(0, "volumechuva -4", 0);
		volumechuva = -4;
		volumechuva8 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 454000 and chovendo == 1 and volumechuva7 == 0) {
		volumechuva = -6;
		send_reliable(0, "volumechuva -6", 0);
		volumechuva7 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 457000 and chovendo == 1 and volumechuva6 == 0) {
		volumechuva = -8;
		send_reliable(0, "volumechuva -8", 0);
		volumechuva6 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 480000 and chovendo == 1 and volumechuva5 == 0) {
		volumechuva = -10;
		send_reliable(0, "volumechuva -10", 0);
		volumechuva5 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (chuvatimer.elapsed >= 499000 and chovendo == 1 and trov8 == 0) {
		jraio();
		volumechuva = -12;
		send_reliable(0, "volumechuva -12", 0);
		trov8 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
			players[i].dirty -= random(1, 2);
			players[i].wet -= random(1, 2);
		}
	}
	if (windtimer.elapsed > windtempo and windendo == 0) {
		windtimer.restart();
		send_reliable(0, "volumewind -7", 0);
		volumewind = -12;
		numerowind = random(3, 4);
		send_reliable(0, "windativa " + numerowind, 0);
		windendo = 1;
		wtrov1 = 0;
		wtrov2 = 0;
		wtrov3 = 0;
		wtrov4 = 0;
		wtrov5 = 0;
		wtrov6 = 0;
		wtrov7 = 0;
		wtrov8 = 0;
		wtrov9 = 0;
		wtrov10 = 0;
		volumewind1 = 0;
		volumewind2 = 0;
		volumewind3 = 0;
		volumewind4 = 0;
		volumewind5 = 0;
		volumewind6 = 0;
		volumewind7 = 0;
		volumewind8 = 0;
		volumewind9 = 0;
		volumewind10 = 0;
	}
	if (windtimer.elapsed > 65000 and windendo == 1) {
		windtimer.restart();
		send_reliable(0, "fimwind", 0);
		send_reliable(0, "volumewind -12", 0);
		windendo = 0;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 1500 and windendo == 1 and wtrov2 == 0) {
		send_reliable(0, "volumewind -12", 0);
		wtrov2 = 1;
		volumewind = -12;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 20000 and windendo == 1 and wtrov9 == 0) {
		volumewind = -10;
		send_reliable(0, "volumewind -10", 0);
		wtrov9 = 1;
	}
	if (windtimer.elapsed >= 43000 and windendo == 1 and wtrov10 == 0) {
		volumewind = -8;
		send_reliable(0, "volumewind -8", 0);
		wtrov10 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 45000 and windendo == 1 and volumewind1 == 0) {
		volumewind = -6;
		volumewind1 = 1;
	}
	if (windtimer.elapsed >= 47000 and windendo == 1 and volumewind2 == 0) {
		send_reliable(0, "volumewind -4", 0);
		volumewind = -4;
		volumewind2 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 48000 and windendo == 1 and volumewind3 == 0) {
		send_reliable(0, "volumewind -2", 0);
		volumewind = -2;
		volumewind3 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 50000 and windendo == 1 and volumewind4 == 0) {
		send_reliable(0, "volumewind 1000", 0);
		volumewind = 1000;
		volumewind4 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 53000 and windendo == 1 and volumewind9 == 0) {
		volumewind = -2;
		send_reliable(0, "volumewind -2", 0);
		volumewind9 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 55000 and windendo == 1 and volumewind8 == 0) {
		send_reliable(0, "volumewind -4", 0);
		volumewind = -4;
		volumewind8 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 59000 and windendo == 1 and volumewind7 == 0) {
		volumewind = -6;
		send_reliable(0, "volumewind -6", 0);
		volumewind7 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 61000 and windendo == 1 and volumewind6 == 0) {
		volumewind = -8;
		send_reliable(0, "volumewind -8", 0);
		volumewind6 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 64000 and windendo == 1 and volumewind5 == 0) {
		volumewind = -10;
		send_reliable(0, "volumewind -10", 0);
		volumewind5 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (windtimer.elapsed >= 64000 and windendo == 1 and trov8 == 0) {
		volumewind = -12;
		send_reliable(0, "volumewind -12", 0);
		trov8 = 1;
		for (uint i = 0; i < players.length(); i++) {
			//players[i].temperaturelevel-=random(0,1);
		}
	}
	if (gcl.elapsed >= 3600000) {
		gcl.restart();
		weapons.resize(0);
		objs.resize(0);
		robots.resize(0);
		send_reliable(0, "The automation of the game has begun to clean the garbage to reduce the lag. Please note, this can lead to a temporary server delay for a few seconds when cleaning is in progress. We appreciate your patience.", 2);
		send_reliable(0, "play_s garbage_collect.ogg", 6);
		send_reliable(0, "garbage_collect", 0);
		garbage_collect();
	}
	if (divulgar.elapsed >= random(1150000, 1600000)) {
		divulgar.restart();
		string[] msgs;
		msgs.insert_last("Please log in at least once in 6 months to avoid your account and house being destroyed");
		msgs.insert_last("If you need help, press f7 to send a message to the staff. dont send irrelivent messages.");
		msgs.insert_last("Love this game? share it to your friends too: https://uw.posix.live");
		msgs.insert_last("join us on telegram to discuss more about the game: https://t.me/+87hXLwoqOvM4M2Zl");
		msgs.insert_last("Teleporters can be used to remove yourself from an unknown area by pressing ault v and pressing backspace to choose where you want to go.");
		msgs.insert_last(" If you would like a TeamTalk account, please visit the link to our tt assistant. https://t.me/UltraWorldTTBot");
		msgs.insert_last("Join us on whatsapp at https://chat.whatsapp.com/LkjhAmvhIK9AZsfTsLj0Bp?mode=ems_share_t");
msgs.insert_last("contribute to our game at: https://github.com/amirmahdifard/ultraworld/");
		int frase = random(0, msgs.length() - 1);
		send_reliable(0, "notify_startrek_chime " + msgs[frase], 0);
	}
	while ((e = n.request()).type != event_none) {
		if (e.type == event_connect) {
			string ip = n.get_peer_address(e.peer_id);
			int count = 0;
			string cs = "0";
			if(ip_conn_counts.exists(ip)){
				ip_conn_counts.get(ip, cs);
				count = string_to_number(cs);
			}
			if(count >= MAX_CONNS_PER_IP){
				n.disconnect_peer(e.peer_id);
				continue;
			}
			count++;
			ip_conn_counts.set(ip, ""+count);
			peer_ip_map.set(""+e.peer_id, ip);
		}
		if (e.type == event_disconnect) {
			string ip;
			if(peer_ip_map.exists(""+e.peer_id)){
				peer_ip_map.get(""+e.peer_id, ip);
				peer_ip_map.delete(""+e.peer_id);
				if(ip_conn_counts.exists(ip)){
					string cs;
					ip_conn_counts.get(ip, cs);
					int count = string_to_number(cs);
					if(count > 0) count--;
					ip_conn_counts.set(ip, ""+count);
				}
			}
			int index = get_player_index(e.peer_id);
			authenticated_peers.delete("" + e.peer_id);
			if (index > -1) {
				n.disconnect_peer_softly(players[index].peer_id);
				log("disconnections", players[index].name + " lost connection", true, true);
				for (uint i2 = 0; i2 < arenas.length(); i2++) {
					if (players[index].map == arenas[i2].map) {
						players[index].bullet_proof_vested = 0;
						players[index].bullet_proof_vestshots = 0;
						players[index].armored = 0;
						players[index].armorshots = 0;
						players[index].large_armor_plated = 0;
						players[index].large_armor_plateshots = 0;
						players[index].shielded = 0;
						players[index].shieldshots = 0;
						players[index].steel_shielded = 0;
						players[index].steel_shieldshots = 0;
						players[index].hurtlevel = 0;
						players[index].hurttimer.restart();
						players[index].healtimer.restart();
						players[index].poisoned = false;
						players[index].hurt = false;
						players[index].cbombplacing = false;
						players[index].drunk = false;
						if (players[index].weapon_name != "fists") {
							players[index].weapon_name = "fists";
							if (players[index].weapon_ammos > 0)
								players[index].inv_add_item(players[index].weapon_ammo_type, players[index].weapon_ammos);
							players[index].firetimer = 180;
							players[index].weapon_ammos = 0;
							players[index].weapon_ammo_type = "";
							players[index].weapon_copasity = 0;
							send_reliable(players[index], "notrapid", 0);
						}
						int newx = string_to_number(get_char_val(players[index].name, "oldx"));
						int newy = string_to_number(get_char_val(players[index].name, "oldy"));
						int newz = string_to_number(get_char_val(players[index].name, "oldz"));
						string charfolder = "chars/" + players[index].name;
						scd(players[index]);
						if (players[index].inv.get_size() > 0) players[index].inv.reset();
						file_copy(charfolder + "/oldinv.usr", charfolder + "/inv.usr", true);
						if (players[index].inv.get_size() < 1) players[index].inv_add_item("starter_pack", 1);
						load_char_data(players[index], true);
						file_delete(charfolder + "/oldx.usr");
						file_delete(charfolder + "/oldy.usr");
						file_delete(charfolder + "/oldz.usr");
						file_delete(charfolder + "/oldmaplayers[index].usr");
						file_delete(charfolder + "/oldinv.usr");
						move_player(players[index], "main_map", newx, newy, newz);
						arenas[i2].joined--;
						int amath = arenas[i2].length - arenas[i2].joined;
						if (arenas[i2].length > 1) send_reliable(0, "arena " + players[index].name + " has escaped from " + arenas[i2].owner + "'s " + arenas[i2].type + " Arena. " + amath + " participators stil left.", 0);
						else send_reliable(0, "arena " + players[index].name + " has escaped from " + arenas[i2].owner + "'s " + arenas[i2].type + " Arena", 0);
						if (players[index].pvpd == 1 and players[index].pvp == 1) {
							players[index].pvp = 0;
							players[index].pvpd = 0;
						}
						if (players[index].pvpd == 3) {
							players[index].pvp = 1;
							players[index].pvpd = 2;
						}
						remove_player(players[index].name, true);
						return;
					}
				}
				if (cheatercheck(players[index]) || players[index].cheater == 1 || file_exists("chars/" + players[index].name + "/cheater.usr")) {
					create_temp_ban(players[index].name, 60000);
					write_to(players[index].name, "cheater.usr", players[index].name + " is a cheater! They closed the game in " + ms_to_readable_time(players[index].statchangetimer.elapsed) + " of being hit");
					send_reliable(0, players[index].name + " is a cheater!", 2);
					players[index].persisttimer.restart();
					players[index].disconnected = true;
				} else if (players[index].nuclearbombspawned == 1) {
					create_temp_ban(players[index].name, 60000);
					players[index].persisttime = 60000;
					players[index].persisttimer.restart();
					players[index].disconnected = true;
				} else
					remove_player(players[index].name, true);
			}
		}
		if (e.type == event_receive) {
			if (e.channel == 1) {
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, "" + players[index].nickname + " is no longer away", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_packet(6, "play afkoff.ogg " + players[index].x + " " + players[index].y + " " + players[index].z, players[index].x, players[index].y, players[index].z, maps[get_map_index(players[index].map)]);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					string message = get_event_message();
					if (filter(message)) {
						send_reliable(players[index], "The server has detected a crash code. The server will prevent these messages from going through.", 2);
						send_reliable(0, "play_s notice.ogg", 6);
						send_reliable(0, "warning! The player " + players[index].nickname + " is trying to send crash codes through the chat!", 2);
						remove_player(players[index].name);
						return;
					}
					if (string_left(get_event_message(), 1) != "/") {
						if (players[index].ds.find("chat") > -1) {
							send_reliable(players[index], "your chats have been disabled", 0);
							return;
						}
						if (players[index].away == true and message != "/afk" and players[index].is_admin() == false) {
							send_reliable(players[index], "You can't chat while you are away", 2);
							return;
						}
						if (chatting == 0) {
							string message;
							message = "Sorry, server chats are currently disabled.";
							if (players[index].is_admin()) message += " If you want to turn them back on, type /varset chatting 1";
							send_reliable(players[index], message, 2);
							return;
						}
						players[index].chats += 1;
						log(players[index].name + "_chats", players[index].name + " said " + get_event_message(), true, true);
						string chatmessage = get_event_message();
						if (players[index].drunk == true) {
							int action = random(1, 2);
							if (action == 1) chatmessage = chatmessage; //do nothing.
							else if (action == 2) chatmessage = string_replace(chatmessage, " ", "", true);
							else if (action == 3) chatmessage = string_reverse(chatmessage);
						}
						string chatmess;
						if (players[index].teamname != "") chatmess += team_name(players[index].teamname) + " ";
						if (players[index].prisontitle != "") chatmess += players[index].prisontitle + " ";
						if (players[index].newbtitle != "") chatmess += players[index].newbtitle + " ";
						if (players[index].pvptitle != "") chatmess += players[index].pvptitle + " ";
						if (players[index].jobtitle != "") chatmess += players[index].jobtitle + " ";
						chatmess += players[index].nickname + ": " + chatmessage;
						players[index].chat(chatmess);
						return;
					} else {
						if (index > -1)
							log(players[index].name + "_commands", players[index].nickname + " (" + players[index].name + ") sent " + get_event_message());
					}
					command(players[index], get_event_message());
				}
			}
			else if (e.channel == 0) {
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, "" + players[index].name + " is no longer away.", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_reliable(0, "play_s afkoff.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					player_event(players[index], get_event_message());
				}
			}
			else if (e.channel == 3) {
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, players[index].nickname + " is no longer away", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_packet(6, "play afkoff.ogg " + players[index].x + " " + players[index].y + " " + players[index].z, players[index].x, players[index].y, players[index].z, maps[get_map_index(players[index].map)]);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					voicechat(players[index], get_event_message());
				}
			}
			else if (e.channel == 4) {
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, players[index].nickname + " is no longer away", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_packet(6, "play afkoff.ogg " + players[index].x + " " + players[index].y + " " + players[index].z, players[index].x, players[index].y, players[index].z, maps[get_map_index(players[index].map)]);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					use(players[index], get_event_message());
					return;
				}
			}
			else if (e.channel == 5) {
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, players[index].nickname + " is no longer away", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_packet(6, "play afkoff.ogg " + players[index].x + " " + players[index].y + " " + players[index].z, players[index].x, players[index].y, players[index].z, maps[get_map_index(players[index].map)]);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					combine(players[index], get_event_message());
					return;
				}
			}
			else if (e.channel == 6) {
				string[] parsed = string_split(get_event_message(), " ", true);
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, players[index].nickname + " is no longer away", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_packet(6, "play afkoff.ogg " + players[index].x + " " + players[index].y + " " + players[index].z, players[index].x, players[index].y, players[index].z, maps[get_map_index(players[index].map)]);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					useitem(players[index], get_event_message());
					return;
				}
			}
			else if (e.channel == 7) {
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, players[index].nickname + " is no longer away", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_packet(6, "play afkoff.ogg " + players[index].x + " " + players[index].y + " " + players[index].z, players[index].x, players[index].y, players[index].z, maps[get_map_index(players[index].map)]);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					play(players[index], get_event_message());
				}
			}
			else if (e.channel == 8) {
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, players[index].nickname + " is no longer away", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_packet(6, "play afkoff.ogg " + players[index].x + " " + players[index].y + " " + players[index].z, players[index].x, players[index].y, players[index].z, maps[get_map_index(players[index].map)]);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					move(players[index], get_event_message());
				}
			}
			else if (e.channel == 9) {
				int index = get_player_index(e.peer_id);
				if (index > -1) {
					players[index].idle.restart();
					if (players[index].away == true) {
						players[index].away = false;
						pesend(0, players[index].nickname + " is no longer away", name = players[index].name);
						players[index].awaytitle = "";
					}
					if (players[index].pvp_stop) {
						players[index].pvp_stop = false;
						send_reliable(players[index], "play_s terror.ogg", 6);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while turning off your pvp!", 2);
					}
					if (players[index].afking) {
						players[index].afking = false;
						players[index].afk = false;
						send_packet(6, "play afkoff.ogg " + players[index].x + " " + players[index].y + " " + players[index].z, players[index].x, players[index].y, players[index].z, maps[get_map_index(players[index].map)]);
						send_reliable(players[index], "error! " + players[index].nickname + ", please don't touch your keyboard while going afk!", 2);
						write_to(players[index].name, "afk.usr", players[index].afk);
						write_to(players[index].name, "afkseconds.usr", players[index].afkseconds);
						players[index].afktitle = "";
					}
					weapon_e(players[index], get_event_message());
				}
			}
			else if (e.channel == 10) {
				int index = get_player_index(e.peer_id);
				string[] parsed = string_split(get_event_message(), " ", true);
				messager md = event_message_as_object;
				if (md.get_value("message") == "login") {
					string name = md.get_value("name");
					string password = md.get_value("password");
					if (name == "" || password == "") return;
					string yv = md.get_value("yv");
					string compid = md.get_value("compid");
					string node_id = md.get_value("node_id");
					login(name, password, yv, e.peer_id, compid, node_id);
					return;
				} else if (md.get_value("message") == "newchar") {
					string name = md.get_value("name");
					string password = md.get_value("password");
					string email = md.get_value("email");
					int gender = stn(md.get_value("gender", "-1"));
					if (gender == -1) return;
					string yv = md.get_value("yv");
					string compid = md.get_value("compid");
					string node_id = md.get_value("node_id");
					create_char(name, password, email, gender, e.peer_id, yv, compid, node_id);
					return;
				} else if (parsed[0] == "ping") {
					int index = get_player_index(e.peer_id);
					if (index > -1)
						send_reliable(players[index], "pong", 0);
				} else if (parsed[0] == "newplayer" and parsed.length() > 7) {
					string auth_name = "";
					string peer_addr = n.get_peer_address(e.peer_id);
					
					if (!authenticated_peers.get("" + e.peer_id, auth_name) || auth_name != parsed[5]) {
						admintell("Security Alert: Peer " + e.peer_id + " (IP: " + peer_addr + ") tried to spoof username '" + parsed[5] + "'. Authenticated as '" + auth_name + "'. Disconnecting.");
						send_reliable(e.peer_id, "block Authentication failed. Please log in properly.", 0);
						n.disconnect_peer(e.peer_id);
						return;
					}
					int hide = string_to_number(get_char_val(parsed[5], "hidden"));
					calendar d;
					writeto(parsed[5], "data", "", "lastseen", join({d.year, d.month, d.day, d.hour, d.minute, d.second}, "/"));
					spawn_player(string_to_number(parsed[1]), string_to_number(parsed[2]), string_to_number(parsed[3]), parsed[4], parsed[5], e.peer_id, parsed[6], string_replace(parsed[7], "[spce]", " ", true), n.get_peer_address(e.peer_id), string_replace(get_event_message(), parsed[0] + " " + parsed[1] + " " + parsed[2] + " " + parsed[3] + " " + parsed[4] + " " + parsed[5] + " " + parsed[6] + " " + parsed[7], "", false), hide);
					int index = get_player_index(e.peer_id);
					if (index > -1) {
						writeto(parsed[5], "data", "", "lastseen", join({d.year, d.month, d.day, d.hour, d.minute, d.second}, "/"));
						load_char_data(players[index]);
						dictionary@ margs = default_mapvars;
						margs.set("myname", players[index].name);
						margs.set("mynick", players[index].nickname);
						for (uint i = 0; i < players.length(); i++) {
							if (players[i].readolmsg == 1 and players[index].name != "smart_bot") {
								string omsg = players[index].onmsg;
								margs.set("name", players[i].name);
								margs.set("nickname", players[i].nickname);
								omsg = mapvars(omsg, margs);
								omsg = genderreplace(players[index].gender, omsg, "%g_");
								send_reliable(players[i], "connections " + omsg + "", 0);
							}
						}
						string charfolder = "chars/" + players[index].name;
						check_maps_for(players[index].name);
						if (file_exists(charfolder + "/prison.usr")) players[index].prison = true;
						string test;
						index = get_player_index_from(parsed[5]);
						if (index > -1 and players[index].warnlevel > 0) {
							send_reliable(players[index], "play_s warn.ogg", 6);
							send_reliable(players[index], "dlg warning! " + players[index].warning + ".", 0);
						}
						if (msounds.length() > 0)
							for (uint i = 0; i < msounds.length(); i++)
								send_reliable(players[index], "createmsound " + msounds[i].id + " " + msounds[i].soundloop + " " + msounds[i].x + " " + msounds[i].y + " " + msounds[i].z + " " + msounds[i].map + " " + msounds[i].pitch, 4);
						players[index].statchangetimer.force(60000);
						if (chovendo == 1) {
							send_reliable(players[index], "volumechuva " + volumechuva, 0);
							send_reliable(players[index], "chuvaativa", 0);
						}
						if (windendo == 1) {
							send_reliable(players[index], "volumewind " + volumewind, 0);
							send_reliable(players[index], "windativa", 0);
						}
						if (nightendo == 1) {
							send_reliable(players[index], "volumenight " + volumenight, 0);
							send_reliable(players[index], "nightativa", 0);
						}
						string ms;
						if (players[index].langchan == "disable_chat") ms = "welcome" + players[index].gender2 + "! press shift h or type /help to see help";
						else ms = "welcome" + players[index].gender2 + "! press shift h or type /help to see help: message of the day: ";
						ms += motd;
						send_reliable(players[index], ms, 2);
						send_reliable(players[index], "play_s welcome" + random(1, 19) + ".ogg", 6);
						titlecheck(players[index]);
						string[] chars = find_directories("chars/*");
						string type = chars[random(0, chars.length() - 1)];
						if (players[index].team_invite != "") bsend(players[index].peer_id, "notifications", "teaminvite.ogg", "You have an invited team " + players[index].team_invite + " team. Type /ati to accept and /rti to refuse");
						//send_reliable(players[index],"This connection is sponsored by "+type,2);
						//if(players[index].paid==1) send_reliable(0,""+players[index].name+" is a paid user",2);
						string teamteam = get_charval(players[index].name, "team");
						if (teamteam != "") {
							players[index].teamname = teamteam;
							checkteam(players[index].name);
							teamteam = players[index].teamname;
							if (team_exists(teamteam)) {
								int tx = get_team_index(teamteam);
								if (players[index].hidden == 0) pesend(0, players[index].name + " is in " + team_name(teamteam, teamteam) + " team");
							}
						}
						if (players[index].pvp == 1) send_reliable(players[index], "you are now pvp", 2);
						if (auction::doing) {
							send_reliable(players[index], "play_s notify_blips.ogg", 6);
							if (auction::list.length() == 1)
								send_reliable(players[index], "auctions there's an auction in progress: " + auction::info, 0);
							else
								send_reliable(players[index], "auctions " + auction::info, 0);
						}
						if (doublexp == 1) {
							send_reliable(players[index], "play_s notify_applause.ogg", 6);
							send_reliable(players[index], "Double xp is enabled", 2);
						} else if (superxp == 1) {
							send_reliable(players[index], "play_s notify_applause.ogg", 6);
							send_reliable(players[index], "Super xp is enabled", 2);
						} else if (megaxp == 1) {
							send_reliable(players[index], "play_s notify_applause.ogg", 6);
							send_reliable(players[index], "mega xp is enabled", 2);
						} else if (gigaxp == 1) {
							send_reliable(players[index], "play_s notify_applause.ogg", 6);
							send_reliable(players[index], "giga xp is enabled", 2);
						} else if (masterxp == 1) {
							send_reliable(players[index], "play_s notify_applause.ogg", 6);
							send_reliable(players[index], "master xp is enabled", 2);
						}
						if (hide > 0) {
							players[index].is_dead = true;
							send_reliable(players[index], "play_s notify8.ogg", 6);
							send_reliable(players[index], "you are currently hiding", 2);
						}
						string pfolder = "chars/" + players[index].name + "/";
						file f;
						f.open(pfolder + "pms.usr", "rb");
						string fread = f.read();
						f.close();
						if (fread != "") {
							string[] pms = string_split(fread, "\r\n", false);
							dictionary sender_counts;
							for (uint i = 0; i < pms.length(); i++) {
								int pos1 = string_contains(pms[i], ";", 1);
								int pos2 = string_contains(pms[i], ";", 2);
								int pos3 = string_contains(pms[i], ";", 3);
								if (pos1 > -1 && pos2 > -1 && pos3 > -1) {
									string sName = pms[i].substr(0, pos1);
									string sNick = pms[i].substr(pos1 + 1, pos2 - (pos1 + 1));
									string sReply = pms[i].substr(pos2 + 1, pos3 - (pos2 + 1));
									string sMsg = pms[i].substr(pos3 + 1);
									messager a;
									a.add("message", "pm");
									a.add("name", sName);
									a.add("dname", sNick);
									a.add("msg", sMsg);
									if (sReply == "1") a.add("reply", "1");
									send(players[index].peer_id, a, 0);
									double count = 0;
									if (sender_counts.exists(sName)) sender_counts.get(sName, count);
									sender_counts.set(sName, count + 1);
								} else if (pos1 > -1 && pos2 > -1) {
									string sName = pms[i].substr(0, pos1);
									string sNick = pms[i].substr(pos1 + 1, pos2 - (pos1 + 1));
									string sMsg = pms[i].substr(pos2 + 1);
									messager a;
									a.add("message", "pm");
									a.add("name", sName);
									a.add("dname", sNick);
									a.add("msg", sMsg);
									send(players[index].peer_id, a, 0);
									double count = 0;
									if (sender_counts.exists(sName)) sender_counts.get(sName, count);
									sender_counts.set(sName, count + 1);
								} else {
									send_reliable(players[index], "pm " + pms[i], 0);
								}
							}
							string[] senders = sender_counts.get_keys();
							for(uint i=0; i<senders.length(); i++) {
								player@ s = get_player_obj_from(senders[i]);
								if (@s != null) {
									double count = 0;
									sender_counts.get(senders[i], count);
									bsend(s.peer_id, "notifications", "pm.ogg", players[index].name + " read your " + count + " offline message" + (count > 1 ? "s" : "") + ".");
								}
							}
							f.open(pfolder + "pms.usr", "wb");
							f.write("");
							f.close();
						}
						f.open(pfolder + "replys.usr", "rb");
						string fread2 = f.read();
						f.close();
						if (fread2 != "") {
							string[] pms = string_split(fread2, "\r\n", false);
							for (uint i = 0; i < pms.length(); i++)
								send_reliable(players[index], "pm " + pms[i], 0);
							f.open(pfolder + "replys.usr", "wb");
							f.write("");
							f.close();
						}
						if (DATE_DAY == players[index].day and DATE_MONTH == players[index].month and players[index].giftlimit < 1) {
							send_reliable(players[index], "happy berthday to you " + players[index].name + "!", 2);
							if (players[index].gender == 0)players[index].gender2 = "he";
							else players[index].gender2 = "she";
							send_reliable(0, "today is birthday of " + players[index].name + " and " + players[index].gender2 + " is now " + players[index].age + " years old!", 2);
							players[index].giftlimit++;
							int n = random(1, 2);
							if (n == 1) send_reliable(0, "play_s fireworkloop.ogg", 6);
							else if (n == 2) send_reliable(0, "play_s fireworkloop.ogg", 6);
							send_reliable(0, "play_s applause" + random(1, 6) + ".ogg", 6);
							file f;
							f.open("chars/" + players[index].name + "/eml.usr", "wb");
							string eml = f.read();
							f.close();
							//url_post("http://balls.com/dl/mail.php","who="+eml+"&from=balls.com&name=Ultra World&sub=Happy berthday, "+players[index].name+"!&mess=Hello.\r\nHappy berthday to you "+players[index].name+"!\r\n\r\nThis message was automated by Ultra World. Please do not reply.");
						}
						if (players[index].langchan == "" or players[index].age == 0 or players[index].country == "" or players[index].day == 0 or players[index].month == 0 or players[index].year == 0)
							send_reliable(players[index], "You didn't complete your profile yet, please go to your smart phone to complete your profile", 2);
						if (players[index].sitting == 1) send_reliable(players[index], "sitstart", 0);
						else if (players[index].sitting == 0) send_reliable(players[index], "sitstop", 0);
						if (players[index].langchan == "") {
							server_menu menu;
							menu.intro = "Select a new language channel";
							menu.initial_packet = "lchannelset";
							for (uint i = 0; i < language_channels.length(); i += 1)
								menu.add(language_channels[i], language_channels[i]);
							menu.add("password protected channels", "ppc");
							menu.send(e.peer_id);
						}
					}
				} else if (parsed[0] == "compinfo" and parsed.length() > 1 && index > -1) {
					string comptext = players[index].name + " (" + string_replace(get_event_message(), "compinfo ", "", false) + ") from IP " + n.get_peer_address(e.peer_id) + ", computer ID " + players[index].compid + "\r\n";
					file f;
					f.open("chars/" + players[index].name + "/info.usr", "wb");
					f.write("last seen: " + get_date() + " at " + get_time() + "\r\ncomp info:\r\n" + comptext + "\r\nlocation:\r\n");
					f.close();
					f.open("compchars.log", "rb");
					string orgtext = f.read();
					f.close();
					if (string_contains(orgtext, comptext, 1) < 0) {
						f.open("compchars.log", "ab");
						f.write(comptext);
						f.close();
					}
					players[index].ctext = comptext;
				} else if (parsed[0] == "staffcheck" && index > -1) {
					if (file_exists("chars/" + players[index].name + "/sponsor.usr")) {
						send_plus(players[index].peer_id, "play_s afktimer.ogg", 6);
						send_plus(players[index].peer_id, players[index].name + " is a sponsor to this game", 2);
					}
					if (players[index].lchm) {
						chnotify(players[index].langchan, players[index].name + " is a language channel manager of this channel", "notify4.ogg");
					}
					if (players[index].in_lcm) send(players[index].peer_id, "islcm", 0);
					if (devs.find(players[index].name) > -1 && !file_exists(staff.folder + "/" + players[index].name + "/developer" + staff.ext)) file_put(staff.folder + "/" + players[index].name + "/developer" + staff.ext, "Auto");
					for (uint si = 0; si < staff.types.length(); si++) {
						if (!is_staff(players[index].name, staff.types[si])) continue;
						send(players[index].peer_id, "isstaff " + staff.types[si], 0);
						string stitle = staff.title(staff.types[si]);
						players[index].sendpacket("You are " + string_article(stitle) + " " + stitle + ". Type /adminrules to view staff rules, and Alt+S to bring up your control panel", 2);
					}
					team@ t = team_obj(get_charval(players[index].name, "team"));
					if (@t != null) {
						if (t.is_leader(players[index].name)) t.transmit2(players[index].name + " is the leader of this team!", "teamn", "teammmessage.ogg");
						else if (t.is_mod(players[index].name)) t.transmit2(players[index].name + " is a moderator of this team!", "teamn", "teammmessage.ogg");
					}
				} else if (parsed[0] == "setvoice" and parsed.length() > 2 && index > -1) {
					players[index].voice = string_to_number(parsed[1]);
				}
			}
		}
	}
	} catch {
		string exf = get_exception_info() + "\n---\n" + last_exception_call_stack;
		file_put("e.log", exf + "\n\n", FILE_APPEND);
		println(exf);
	}
}